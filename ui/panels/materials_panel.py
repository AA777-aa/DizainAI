"""
–ü–∞–Ω–µ–ª—å —Ä–∞—Å—á—ë—Ç–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
"""

from PyQt5.QtWidgets import (
    QWidget, QVBoxLayout, QHBoxLayout, QLabel,
    QPushButton, QGroupBox, QTextEdit, QTableWidget,
    QTableWidgetItem, QHeaderView, QTabWidget,
    QFileDialog, QMessageBox
)
from PyQt5.QtCore import Qt

from core.project import Project
from core.materials_calc import MaterialsCalculator


class MaterialsPanel(QWidget):
    """–ü–∞–Ω–µ–ª—å —Ä–∞—Å—á—ë—Ç–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤"""

    def __init__(self, project: Project, parent=None):
        super().__init__(parent)
        self.project = project

        self._setup_ui()

    def _setup_ui(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞"""
        layout = QVBoxLayout(self)
        layout.setContentsMargins(5, 5, 5, 5)

        # –ó–∞–≥–æ–ª–æ–≤–æ–∫
        header = QLabel("üß± –†–∞—Å—á—ë—Ç —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤")
        header.setStyleSheet("font-size: 14px; font-weight: bold;")
        layout.addWidget(header)

        # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µ
        self.info_label = QLabel()
        self.info_label.setWordWrap(True)
        layout.addWidget(self.info_label)

        # –ö–Ω–æ–ø–∫–∞ —Ä–∞—Å—á—ë—Ç–∞
        calc_btn = QPushButton("üìä –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª—ã")
        calc_btn.clicked.connect(self._calculate)
        layout.addWidget(calc_btn)

        # –í–∫–ª–∞–¥–∫–∏ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
        self.tabs = QTabWidget()

        # –¢–∞–±–ª–∏—Ü–∞
        self.table = QTableWidget()
        self.table.setColumnCount(5)
        self.table.setHorizontalHeaderLabels([
            "–ú–∞—Ç–µ—Ä–∏–∞–ª", "–ö–æ–ª-–≤–æ", "–ï–¥.", "–° –∑–∞–ø–∞—Å–æ–º", "–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ"
        ])
        self.table.horizontalHeader().setSectionResizeMode(0, QHeaderView.Stretch)
        self.tabs.addTab(self.table, "üìã –¢–∞–±–ª–∏—Ü–∞")

        # –¢–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á—ë—Ç
        self.text_report = QTextEdit()
        self.text_report.setReadOnly(True)
        self.tabs.addTab(self.text_report, "üìù –û—Ç—á—ë—Ç")

        layout.addWidget(self.tabs)

        # –ö–Ω–æ–ø–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞
        export_layout = QHBoxLayout()

        export_txt_btn = QPushButton("üíæ –≠–∫—Å–ø–æ—Ä—Ç TXT")
        export_txt_btn.clicked.connect(self._export_txt)
        export_layout.addWidget(export_txt_btn)

        export_csv_btn = QPushButton("üìä –≠–∫—Å–ø–æ—Ä—Ç CSV")
        export_csv_btn.clicked.connect(self._export_csv)
        export_layout.addWidget(export_csv_btn)

        layout.addLayout(export_layout)

        self._update_info()

    def update_project(self, project: Project):
        """–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç"""
        self.project = project
        self._update_info()
        self._clear_results()

    def _update_info(self):
        """–û–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–µ–∫—Ç–µ"""
        rooms = len(self.project.rooms)
        area = self.project.total_area

        self.info_label.setText(
            f"üìÅ –ü—Ä–æ–µ–∫—Ç: {self.project.name}\n"
            f"üè† –ö–æ–º–Ω–∞—Ç: {rooms}\n"
            f"üìê –û–±—â–∞—è –ø–ª–æ—â–∞–¥—å: {area:.2f} –º¬≤"
        )

    def _clear_results(self):
        """–û—á–∏—Å—Ç–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã"""
        self.table.setRowCount(0)
        self.text_report.clear()

    def _calculate(self):
        """–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª—ã"""
        if not self.project.rooms:
            QMessageBox.warning(
                self, "–û—à–∏–±–∫–∞",
                "–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∫–æ–º–Ω–∞—Ç—É –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞."
            )
            return

        calc = MaterialsCalculator(self.project)

        # –¢–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á—ë—Ç
        self.text_report.setText(calc.get_summary_text())

        # –¢–∞–±–ª–∏—Ü–∞
        all_materials = calc.calculate_all()

        self.table.setRowCount(0)
        row = 0

        category_names = {
            "walls": "üß± –°–¢–ï–ù–´",
            "floor": "üî≤ –ü–û–õ",
            "ceiling": "‚¨ú –ü–û–¢–û–õ–û–ö",
            "other": "üì¶ –ü–†–û–ß–ï–ï"
        }

        for category, materials in all_materials.items():
            # –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            self.table.insertRow(row)
            header_item = QTableWidgetItem(category_names.get(category, category))
            header_item.setBackground(Qt.lightGray)
            font = header_item.font()
            font.setBold(True)
            header_item.setFont(font)
            self.table.setItem(row, 0, header_item)
            self.table.setSpan(row, 0, 1, 5)
            row += 1

            # –ú–∞—Ç–µ—Ä–∏–∞–ª—ã
            for mat in materials:
                self.table.insertRow(row)
                self.table.setItem(row, 0, QTableWidgetItem(mat.name))
                self.table.setItem(row, 1, QTableWidgetItem(f"{mat.quantity}"))
                self.table.setItem(row, 2, QTableWidgetItem(mat.unit))
                self.table.setItem(row, 3, QTableWidgetItem(f"{mat.with_reserve}"))
                self.table.setItem(row, 4, QTableWidgetItem(mat.notes))
                row += 1

        self.tabs.setCurrentIndex(0)

    def _export_txt(self):
        """–≠–∫—Å–ø–æ—Ä—Ç –≤ TXT"""
        from utils.export import ProjectExporter

        file_path, _ = QFileDialog.getSaveFileName(
            self, "–≠–∫—Å–ø–æ—Ä—Ç –æ—Ç—á—ë—Ç–∞",
            f"{self.project.name}_–º–∞—Ç–µ—Ä–∏–∞–ª—ã.txt",
            "–¢–µ–∫—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã (*.txt)"
        )

        if file_path:
            if ProjectExporter.to_text_report(self.project, file_path):
                QMessageBox.information(
                    self, "–£—Å–ø–µ—Ö",
                    f"–û—Ç—á—ë—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω:\n{file_path}"
                )

    def _export_csv(self):
        """–≠–∫—Å–ø–æ—Ä—Ç –≤ CSV"""
        from utils.export import ProjectExporter

        file_path, _ = QFileDialog.getSaveFileName(
            self, "–≠–∫—Å–ø–æ—Ä—Ç CSV",
            f"{self.project.name}_–º–∞—Ç–µ—Ä–∏–∞–ª—ã.csv",
            "CSV —Ñ–∞–π–ª—ã (*.csv)"
        )

        if file_path:
            if ProjectExporter.to_csv_materials(self.project, file_path):
                QMessageBox.information(
                    self, "–£—Å–ø–µ—Ö",
                    f"CSV —Å–æ—Ö—Ä–∞–Ω—ë–Ω:\n{file_path}"
                )